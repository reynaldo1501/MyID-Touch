<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart IC: Secure RAM Access</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- QR Code Generator & Scanner -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root { --primary-bg: #f3f4f6; --text-main: #1f2937; }
        .high-contrast { --primary-bg: #000000; --text-main: #ffff00; }

        body { font-family: 'Inter', sans-serif; background-color: var(--primary-bg); color: var(--text-main); transition: background 0.3s; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .sos-pulse { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }

        /* Hologram Effect */
        .hologram-card { position: relative; overflow: hidden; }
        .hologram-card::before {
            content: ""; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(115deg, transparent 40%, rgba(255, 255, 255, 0.2) 45%, rgba(255, 255, 255, 0.4) 50%, rgba(255, 255, 255, 0.2) 55%, transparent 60%);
            transform: rotate(25deg); animation: sheen 6s infinite linear; pointer-events: none;
        }
        @keyframes sheen { 0% { transform: translateX(-100%) rotate(25deg); } 100% { transform: translateX(100%) rotate(25deg); } }

        /* Scanner Laser */
        @keyframes scan-line { 0% { top: 0%; } 100% { top: 100%; } }
        .animate-scan-line { animation: scan-line 1.5s linear infinite; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.3s ease-in-out; }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Dead Man's Switch Bar */
        #dms-bar { transition: width 1s linear, background-color 1s; }
        .dms-warning { animation: flash-warning 0.5s infinite; }
        @keyframes flash-warning { 0%, 100% { background-color: #ef4444; } 50% { background-color: #fee2e2; } }

        .high-contrast .bg-white { background-color: #000; border: 2px solid #ffff00; color: #ffff00; }
        .high-contrast .text-gray-500 { color: #00ff00; }
        .high-contrast input, .high-contrast select { background-color: #000; color: #fff; border-color: #fff; }

        /* Scanner Video Fix */
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; border-radius: 1rem; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- DEAD MAN'S SWITCH INDICATOR (Global) -->
    <div id="dms-container" class="fixed top-0 left-0 w-full h-1 z-50 bg-gray-800 hidden">
        <div id="dms-bar" class="h-full bg-emerald-500 w-full"></div>
    </div>

    <!-- HEADER -->
    <header class="bg-blue-900 text-white p-4 pt-5 shadow-md z-10 flex justify-between items-center hidden" id="app-header">
        <div class="flex items-center gap-2">
            <h1 class="text-lg font-bold"><i class="fa-solid fa-id-card"></i> <span id="header-title">Smart IC</span></h1>
            <div class="text-[10px] bg-blue-700 px-2 py-1 rounded" id="header-role-badge">Awam</div>
            <!-- RAM Icon -->
            <div id="ram-status-icon" class="hidden text-[10px] bg-amber-500/20 border border-amber-500 text-amber-300 px-2 py-1 rounded flex items-center gap-1 animate-pulse">
                <i class="fa-solid fa-microchip"></i> RAM
            </div>
        </div>
        <div class="flex gap-3 items-center">
             <button onclick="toggleLanguage()" class="bg-blue-800 px-2 py-1 rounded text-[10px] font-bold border border-blue-400 w-10" id="header-lang-btn">BM</button>
             <button onclick="toggleContrast()" class="bg-blue-800 p-2 rounded-full w-8 h-8 flex items-center justify-center border border-blue-400"><i class="fa-solid fa-circle-half-stroke text-xs"></i></button>
             <button onclick="logout()" class="text-gray-300 hover:text-white text-sm"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto relative pb-20 w-full h-full bg-gray-50 dark:bg-gray-900" id="main-bg">
        
        <!-- === VIEW: LOGIN (LOCKED) === -->
        <div id="view-auth" class="h-full flex flex-col items-center justify-center p-6 bg-gradient-to-b from-slate-900 to-slate-800 text-white relative">
            
            <!-- Lang Switch Login -->
            <button onclick="toggleLanguage()" class="absolute top-6 left-6 text-xs text-slate-400 border border-slate-600 px-3 py-1 rounded-full hover:bg-slate-700" id="login-lang-btn">
                <i class="fa-solid fa-globe mr-1"></i> <span>English</span>
            </button>

            <!-- Security Badge -->
            <div class="absolute top-4 right-4 flex flex-col items-end gap-1">
                <div class="flex items-center gap-2 text-[10px] text-emerald-400 border border-emerald-500/30 px-2 py-1 rounded-full bg-emerald-900/20">
                    <i class="fa-solid fa-memory"></i> <span data-i18n="badge_ram">VOLATILE RAM-DISK</span>
                </div>
                <div class="flex items-center gap-2 text-[10px] text-red-400 border border-red-500/30 px-2 py-1 rounded-full bg-red-900/20">
                    <i class="fa-solid fa-stopwatch"></i> <span data-i18n="badge_dms">DEAD MAN'S SWITCH</span>
                </div>
            </div>

            <div class="mb-6 relative">
                <div class="w-32 h-32 bg-white/5 rounded-full flex items-center justify-center border border-white/10 shadow-[0_0_40px_rgba(239,68,68,0.2)]">
                    <i class="fa-solid fa-lock text-5xl text-red-500 drop-shadow-lg"></i>
                </div>
                <div class="absolute -bottom-2 -right-2 bg-red-600 text-xs font-bold px-3 py-1 rounded-full border border-red-400" data-i18n="status_locked">LOCKED</div>
            </div>
            <div class="mb-8 text-center fade-in z-10">
                <h1 class="text-3xl font-bold mb-1 tracking-tight" data-i18n="app_title">MyID Touch<span class="text-emerald-400">Secure</span></h1>
                <p class="text-sm opacity-70" data-i18n="app_subtitle">Volatile Memory Session</p>
            </div>
            <div class="w-full max-w-sm space-y-4 fade-in z-10">
                
                <!-- Biometric Button -->
                <button onclick="startBiometricAuth('public')" class="w-full bg-gradient-to-r from-emerald-600 to-emerald-500 text-white py-4 rounded-2xl font-bold shadow-[0_10px_20px_rgba(16,185,129,0.2)] hover:from-emerald-500 transition flex items-center justify-center gap-3 border border-emerald-400/50">
                    <i class="fa-solid fa-fingerprint text-xl"></i> 
                    <span data-i18n="btn_fingerprint">UNLOCK VIA FINGERPRINT</span>
                </button>

                <!-- PIN Button -->
                <button onclick="showPinLogin()" class="w-full bg-white text-slate-900 py-3 rounded-xl font-bold shadow hover:bg-gray-100 transition flex items-center justify-center gap-2 text-sm">
                    <i class="fa-solid fa-keyboard"></i> <span data-i18n="btn_pin">Guna Nombor PIN</span>
                </button>

                <div class="flex items-center gap-4 text-xs text-slate-500 my-1">
                    <div class="h-px bg-slate-700 flex-1"></div> <span data-i18n="lbl_officer">Pegawai</span> <div class="h-px bg-slate-700 flex-1"></div>
                </div>

                <!-- Gov Button -->
                <button onclick="showGovLogin()" class="w-full bg-slate-700/30 border border-slate-500/30 text-slate-400 py-3 rounded-xl font-bold hover:bg-slate-700 hover:text-white transition flex items-center justify-center gap-2 text-sm">
                    <i class="fa-solid fa-building-shield"></i> <span data-i18n="btn_officer">Log Masuk Pegawai</span>
                </button>
            </div>
            <p class="absolute bottom-4 text-[10px] text-slate-600" data-i18n="footer_version">Secure RAM-Disk v2.1. Data wipes on power loss.</p>
        </div>

        <!-- === VIEW: BIO SCANNER (SIMULATED) === -->
        <div id="view-bio-scan" class="hidden fixed inset-0 bg-black z-50 flex flex-col">
            <div class="absolute top-0 left-0 right-0 p-4 z-20 flex justify-between bg-black/40 backdrop-blur-md">
                <button onclick="closeBioScanner()" class="text-white text-sm" data-i18n="btn_cancel">Batal</button>
                <span class="text-white text-xs font-bold" data-i18n="loading_ram">LOADING TO RAM...</span>
                <div class="w-8"></div>
            </div>
            <div class="flex-1 relative overflow-hidden flex items-center justify-center bg-slate-900">
                <video id="bio-video" autoplay playsinline muted class="absolute inset-0 w-full h-full object-cover opacity-50"></video>
                <div class="relative z-10 flex flex-col items-center">
                    <div class="w-72 h-72 border-4 border-emerald-500/50 rounded-full flex items-center justify-center relative">
                        <div class="absolute inset-0 border-4 border-t-emerald-400 rounded-full animate-spin"></div>
                    </div>
                    <div class="mt-8 text-center">
                        <p class="text-white font-bold animate-pulse" data-i18n="generating_keys">Generating Volatile Keys...</p>
                        <p class="text-emerald-400 font-mono text-xs mt-2">0x4F...8A stored in RAM</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VIEW: PUBLIC CARD === -->
        <div id="view-card" class="p-4 space-y-6 hidden max-w-md mx-auto fade-in">
            <!-- Security Status Banner -->
            <div id="ram-active-banner" class="bg-amber-900/80 border border-amber-600/50 text-amber-100 p-3 rounded-xl flex items-center gap-3 shadow-sm text-xs backdrop-blur-sm">
                <i class="fa-solid fa-microchip text-lg"></i>
                <div>
                    <p class="font-bold" data-i18n="ram_decrypted_title">RAM-Disk Decrypted</p>
                    <p class="opacity-80" data-i18n="ram_decrypted_desc">Data is live in volatile memory.</p>
                </div>
            </div>

            <!-- Encrypted Banner (Default) -->
            <div id="ram-missing-banner" class="hidden bg-gray-800 border border-gray-600 text-gray-300 p-3 rounded-xl flex items-center gap-3 shadow-sm text-xs">
                <i class="fa-solid fa-lock text-lg"></i>
                <div>
                    <p class="font-bold" data-i18n="ram_encrypted_title">DATA ENCRYPTED</p>
                    <p class="opacity-80" data-i18n="ram_encrypted_desc">Log in to decrypt from storage.</p>
                </div>
            </div>

            <!-- BANTUAN ELIGIBILITY CARD (DYNAMIC) -->
            <div id="aid-status-card" class="hidden rounded-xl p-4 shadow-md border-l-4 flex flex-col gap-2">
                <!-- Content injected via JS -->
            </div>

            <!-- Hologram Card -->
            <div class="hologram-card bg-gradient-to-br from-blue-700 to-indigo-900 text-white rounded-2xl p-5 shadow-2xl relative">
                <div class="flex justify-between items-start mb-4 relative z-10">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/26/Coat_of_arms_of_Malaysia.svg/1200px-Coat_of_arms_of_Malaysia.svg.png" class="h-10 opacity-90">
                    <div class="text-right"><p class="text-[10px] uppercase opacity-80">MyKad Digital</p><p class="text-sm font-bold">MALAYSIA</p></div>
                </div>
                <div class="flex gap-4 items-center relative z-10">
                    <div class="h-16 w-16 bg-white/20 backdrop-blur-md rounded-lg flex items-center justify-center border border-white/30"><i class="fa-solid fa-user text-3xl text-white/80"></i></div>
                    <div>
                        <h2 class="text-lg font-bold truncate w-48" id="card-name">...</h2>
                        <p class="text-sm font-mono opacity-90" id="card-ic">...</p>
                        <div class="flex gap-2 mt-1">
                            <span class="bg-yellow-400 text-blue-900 text-[10px] font-bold px-2 py-0.5 rounded shadow-sm" id="card-category">...</span>
                            <span class="bg-white text-blue-900 text-[10px] font-bold px-2 py-0.5 rounded shadow-sm" id="card-income">...</span>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-between items-end relative z-10">
                    <div class="text-xs opacity-80"><i class="fa-solid fa-wifi rotate-90 mr-1"></i><span data-i18n="nfc_active">NFC Aktif</span></div>
                    <div class="bg-white p-1.5 rounded shadow-lg"><div id="card-qr-small" class="w-12 h-12"></div></div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="triggerSOS()" class="bg-red-600 text-white p-4 rounded-xl font-bold shadow-lg sos-pulse flex flex-col items-center justify-center gap-1 active:scale-95 transition">
                    <i class="fa-solid fa-bell-exclamation text-2xl"></i>
                    <span class="text-xs">SOS</span>
                </button>
                <div class="bg-white p-2 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center justify-center">
                    <div id="main-qr-display" class="scale-75 origin-center"></div>
                </div>
            </div>

            <!-- Vital Stats (SENSITIVE) -->
            <div class="grid grid-cols-2 gap-3 relative">
                <div class="bg-white p-3 rounded-xl border-l-4 border-red-500 shadow-sm relative overflow-hidden">
                    <p class="text-[10px] text-gray-400 font-bold mb-1 uppercase" data-i18n="lbl_blood">Jenis Darah</p>
                    <p class="text-xl font-bold text-gray-800" id="status-blood">-</p>
                    <!-- Mask Overlay -->
                    <div class="sensitive-mask absolute inset-0 bg-gray-200/90 backdrop-blur-sm flex items-center justify-center z-10 hidden">
                        <i class="fa-solid fa-lock text-gray-400"></i>
                    </div>
                </div>
                <div class="bg-white p-3 rounded-xl border-l-4 border-orange-500 shadow-sm relative overflow-hidden">
                    <p class="text-[10px] text-gray-400 font-bold mb-1 uppercase" data-i18n="lbl_allergy">Alergi Utama</p>
                    <p class="text-sm font-bold text-gray-800 truncate" id="status-allergy">-</p>
                      <!-- Mask Overlay -->
                      <div class="sensitive-mask absolute inset-0 bg-gray-200/90 backdrop-blur-sm flex items-center justify-center z-10 hidden">
                        <i class="fa-solid fa-lock text-gray-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- === VIEW: PROFILE EDIT === -->
        <div id="view-profile" class="p-4 pb-24 hidden max-w-md mx-auto fade-in">
             <div class="flex justify-between items-center mb-4">
                 <h2 class="text-xl font-bold text-gray-800" data-i18n="profile_title">Profil Saya</h2>
                 <button onclick="resetData()" class="text-xs text-red-500 underline" data-i18n="btn_reset">Reset Data</button>
             </div>
             <div class="bg-white rounded-xl p-5 shadow-sm space-y-4 border border-gray-100">
                <!-- PIN SETTING -->
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <label class="text-xs font-bold text-slate-600" data-i18n="lbl_pin_set">PIN Keselamatan (6 Digit)</label>
                    <div class="flex gap-2 mt-1">
                        <input type="text" id="input-pin" class="w-full p-2 border rounded font-mono text-center tracking-widest" maxlength="6" placeholder="******">
                        <button onclick="togglePinVisibility()" class="p-2 text-gray-400"><i class="fa-solid fa-eye"></i></button>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1" data-i18n="desc_pin">Digunakan jika biometrik gagal.</p>
                </div>

                <div><label class="text-xs font-bold text-blue-600" data-i18n="lbl_name">Nama Penuh</label><input type="text" id="input-name" class="w-full p-2 border-b-2 outline-none"></div>
                <div><label class="text-xs font-bold text-blue-600" data-i18n="lbl_ic">No. KP</label><input type="text" id="input-ic" class="w-full p-2 border-b-2 outline-none"></div>
                
                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="text-xs font-bold text-gray-500" data-i18n="lbl_category">Kategori</label>
                        <select id="input-category" class="w-full p-2 mt-1 border rounded bg-gray-50 text-sm">
                            <option value="Warga Emas" data-i18n="opt_senior">Warga Emas</option>
                            <option value="OKU (Fizikal)" data-i18n="opt_pwd_phys">OKU (Fizikal)</option>
                            <option value="OKU (Pendengaran)" data-i18n="opt_pwd_hear">OKU (Pendengaran)</option>
                            <option value="Kanak-kanak" data-i18n="opt_child">Kanak-kanak</option>
                            <option value="Normal" data-i18n="opt_normal">Normal</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500" data-i18n="lbl_income">Pendapatan</label>
                        <select id="input-income" class="w-full p-2 mt-1 border rounded bg-gray-50 text-sm font-bold">
                            <option value="B40">B40 (< RM4,850)</option>
                            <option value="M40">M40</option>
                            <option value="T20">T20</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-gray-500" data-i18n="lbl_blood">Darah</label><select id="input-blood" class="w-full p-2 mt-1 border rounded bg-gray-50 text-sm"><option>A+</option><option>B+</option><option>O+</option><option>AB+</option></select></div>
                </div>
                <div><label class="text-xs font-bold text-gray-500" data-i18n="lbl_allergy">Alergi</label><textarea id="input-allergies" class="w-full p-2 mt-1 border rounded h-16 text-sm"></textarea></div>
                
                <div class="bg-blue-50 p-3 rounded-lg">
                    <p class="text-xs font-bold text-blue-800 mb-2 uppercase" data-i18n="lbl_ice">Kontak Kecemasan (ICE)</p>
                    <input type="text" id="input-ice-name" data-i18n="ph_ice_name" placeholder="Nama Waris" class="w-full p-2 border rounded mb-2 text-sm">
                    <input type="tel" id="input-ice-phone" data-i18n="ph_ice_phone" placeholder="No. Telefon" class="w-full p-2 border rounded text-sm">
                </div>
                <button onclick="saveData()" class="w-full bg-blue-700 text-white p-3 rounded-lg font-bold shadow hover:bg-blue-800"><i class="fa-solid fa-floppy-disk mr-2"></i> <span data-i18n="btn_save">Simpan</span></button>
             </div>
        </div>

        <!-- === VIEW: GOV DASHBOARD (UPDATED) === -->
        <div id="view-dashboard" class="hidden p-4 space-y-4 max-w-md mx-auto fade-in">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-green-600 text-white p-4 rounded-xl shadow-lg">
                    <p class="text-2xl font-bold" id="stat-scans">0</p>
                    <p class="text-xs opacity-80" data-i18n="dash_scans">Imbasan Hari Ini</p>
                </div>
                <div class="bg-purple-600 text-white p-4 rounded-xl shadow-lg">
                    <p class="text-2xl font-bold" id="stat-aid">0</p>
                    <p class="text-xs opacity-80" data-i18n="dash_aid">Penerima Bantuan</p>
                </div>
            </div>
            
            <h3 class="font-bold text-gray-700 mt-2" data-i18n="dash_activity">Aktiviti Terkini</h3>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                <ul class="divide-y divide-gray-100" id="recent-scans-list">
                    <li class="p-4 text-sm text-center text-gray-400 italic" data-i18n="dash_no_rec">Tiada rekod imbasan baru.</li>
                </ul>
            </div>
            
            <button onclick="switchTab('scanner')" class="w-full py-4 bg-gray-800 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2">
                <i class="fa-solid fa-camera"></i> <span data-i18n="btn_start_scan">Mula Mengimbas</span>
            </button>
        </div>

        <!-- === VIEW: SCANNER (GOV - UPDATED) === -->
        <div id="view-scanner" class="hidden h-full flex flex-col fade-in bg-black">
             <div class="relative flex-1 flex flex-col items-center justify-center">
                 <div class="absolute top-4 bg-black/50 text-green-400 px-4 py-1 rounded-full text-xs font-mono border border-green-500 z-20">
                    SECURE_LINK_ESTABLISHED
                 </div>
                 
                 <div class="relative w-72 h-72 rounded-3xl overflow-hidden border-4 border-green-500 shadow-[0_0_50px_rgba(34,197,94,0.3)] z-10" id="scan-frame">
                    <div id="reader" class="w-full h-full bg-gray-900"></div>
                    <div class="absolute top-0 w-full h-1 bg-green-500 shadow-[0_0_10px_#22c55e] animate-scan-line" id="scanner-laser"></div>
                    <div id="scan-placeholder" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <i class="fa-solid fa-qrcode text-6xl text-white/20"></i>
                    </div>
                 </div>

                 <div class="mt-8 flex gap-4 z-20" id="scan-controls">
                     <button onclick="startScan()" class="bg-green-600 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition border-4 border-green-800">
                         <i class="fa-solid fa-camera text-2xl"></i>
                     </button>
                     <button onclick="stopCamera()" class="bg-red-600 text-white w-16 h-16 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition hidden" id="btn-stop">
                        <i class="fa-solid fa-stop text-2xl"></i>
                    </button>
                 </div>
                 <p class="text-gray-400 text-xs mt-4 z-20">Halakan pada QR Pengguna</p>
                 <button onclick="switchTab('dashboard')" class="absolute bottom-10 text-white/50 text-sm hover:text-white z-20" data-i18n="btn_back_dash">Kembali ke Dashboard</button>
             </div>
        </div>

    </main>

    <!-- NAVIGATION -->
    <nav id="bottom-nav" class="bg-white border-t border-gray-200 fixed bottom-0 w-full z-20 hidden shadow-[0_-5px_20px_rgba(0,0,0,0.05)] pb-safe"><div class="max-w-md mx-auto flex justify-around" id="nav-items-container"></div></nav>

    <!-- PIN LOGIN MODAL (USER) -->
    <div id="modal-pin-login" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl relative">
            <button onclick="closePinLogin()" class="absolute top-2 right-4 text-gray-400 text-2xl">&times;</button>
            <h3 class="font-bold text-gray-800 text-center text-lg mb-1" data-i18n="pin_title">Masukkan PIN</h3>
            <p class="text-xs text-center text-gray-500 mb-4" data-i18n="pin_desc">6 digit nombor sekuriti anda.</p>
            <input type="password" inputmode="numeric" id="user-pin-input" class="w-full text-center text-3xl tracking-[0.5em] font-mono p-3 border-2 border-slate-200 rounded-xl mb-4 focus:border-blue-600 outline-none" maxlength="6" placeholder="******">
            <button onclick="verifyUserPin()" class="w-full py-3 bg-blue-700 text-white rounded-xl font-bold hover:bg-blue-800" data-i18n="btn_enter">Masuk</button>
            <p class="text-[10px] text-center mt-3 text-gray-400">PIN Asal: 123456</p>
        </div>
    </div>

    <!-- GOV AUTH MODAL -->
    <div id="modal-gov-login" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl relative">
            <button onclick="closeGovLogin()" class="absolute top-2 right-4 text-gray-400 text-2xl">&times;</button>
            <h3 class="font-bold text-gray-800 text-center" data-i18n="gov_access_title">Akses Pegawai</h3>
            <p class="text-xs text-center mb-4 text-gray-500">Kod: 1234</p>
            <input type="password" id="gov-pass" class="w-full text-center text-3xl tracking-widest font-mono p-3 border-2 rounded-xl mb-4" maxlength="4">
            <button onclick="verifyGov()" class="w-full py-3 bg-blue-900 text-white rounded-xl font-bold" data-i18n="btn_verify">Sahkan</button>
        </div>
    </div>

    <!-- RESULT MODAL (UPDATED TO MEDICAL/RED STYLE) -->
    <div id="modal-result" class="fixed inset-0 bg-black/80 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-md">
        <div class="bg-white w-full sm:max-w-sm rounded-t-2xl sm:rounded-2xl overflow-hidden shadow-2xl animate-[slideUp_0.3s_ease-out]">
            <!-- Red Header -->
            <div class="bg-red-600 p-4 text-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-full"><i class="fa-solid fa-file-medical text-xl"></i></div>
                    <div>
                        <h3 class="font-bold text-sm uppercase">Maklumat Kritikal</h3>
                        <p class="text-[10px] opacity-80">Disahkan oleh KKM</p>
                    </div>
                </div>
                <button onclick="closeModal()" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800" id="res-name">-</h2>
                    <p class="text-sm text-gray-500" id="res-ic">-</p>
                    <span class="inline-block bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full mt-2" id="res-category">-</span>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="bg-gray-50 p-3 rounded-lg text-center border">
                        <span class="text-xs text-gray-500 block uppercase">Darah</span>
                        <span class="text-xl font-bold text-gray-800" id="res-blood">-</span>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg text-center border">
                        <span class="text-xs text-gray-500 block uppercase">Penderma</span>
                        <span class="text-xl font-bold text-gray-800">YA</span>
                    </div>
                </div>

                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg mb-4">
                    <p class="text-xs font-bold text-red-600 uppercase mb-1 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> Alergi / Kondisi</p>
                    <p class="text-sm font-medium text-gray-800" id="res-allergies">-</p>
                </div>

                <div class="border-t pt-4">
                    <p class="text-xs font-bold text-gray-400 uppercase mb-3">Tindakan Kecemasan</p>
                    <div class="flex items-center justify-between bg-green-50 p-3 rounded-xl border border-green-200 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="bg-green-200 w-10 h-10 rounded-full flex items-center justify-center text-green-700">
                                <i class="fa-solid fa-user-group"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm" id="res-ice-name">-</p>
                                <p class="text-xs text-green-700">Waris Terdekat</p>
                            </div>
                        </div>
                        <a href="#" id="btn-call" class="bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow hover:bg-green-700 hover:scale-110 transition">
                            <i class="fa-solid fa-phone"></i>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Geo Location Mock -->
            <div class="bg-gray-50 p-2 text-center border-t">
                <p class="text-[10px] text-gray-400 flex items-center justify-center gap-1">
                    <i class="fa-solid fa-location-dot"></i> Lokasi dikesan: <span id="res-geo">Mengesan...</span>
                </p>
            </div>
        </div>
    </div>

    <script>
        // --- INTERNATIONALIZATION (I18N) ---
        const translations = {
            ms: {
                app_title: "MyID Touch",
                app_subtitle: "Sesi Memori Meruap",
                badge_ram: "VOLATILE RAM-DISK",
                badge_dms: "DEAD MAN'S SWITCH",
                status_locked: "DIKUNCI",
                btn_fingerprint: "BUKA KUNCI (CAP JARI)",
                btn_pin: "Guna Nombor PIN",
                lbl_officer: "Pegawai",
                btn_officer: "Log Masuk Pegawai",
                footer_version: "Secure RAM-Disk v2.1. Data dipadam jika tiada kuasa.",
                btn_cancel: "Batal",
                loading_ram: "MEMUAT RAM...",
                generating_keys: "Menjana Kunci Volatile...",
                ram_decrypted_title: "RAM-Disk Didekripsi",
                ram_decrypted_desc: "Data aktif dalam memori meruap.",
                ram_encrypted_title: "DATA DIENKRIPSI",
                ram_encrypted_desc: "Log masuk untuk dekripsi dari storan.",
                nfc_active: "NFC Aktif",
                lbl_blood: "Jenis Darah",
                lbl_allergy: "Alergi Utama",
                profile_title: "Profil Saya",
                btn_reset: "Reset Data",
                lbl_pin_set: "PIN Keselamatan (6 Digit)",
                desc_pin: "Digunakan jika biometrik gagal.",
                lbl_name: "Nama Penuh",
                lbl_ic: "No. KP",
                lbl_category: "Kategori",
                lbl_income: "Pendapatan",
                lbl_ice: "Kontak Kecemasan (ICE)",
                ph_ice_name: "Nama Waris",
                ph_ice_phone: "No. Telefon",
                btn_save: "Simpan",
                dash_scans: "Imbasan Hari Ini",
                dash_aid: "Penerima Bantuan",
                dash_activity: "Aktiviti Terkini",
                dash_no_rec: "Tiada rekod imbasan baru.",
                btn_start_scan: "Mula Mengimbas",
                btn_back_dash: "Kembali ke Dashboard",
                pin_title: "Masukkan PIN",
                pin_desc: "6 digit nombor sekuriti anda.",
                btn_enter: "Masuk",
                gov_access_title: "Akses Pegawai",
                btn_verify: "Sahkan",
                res_valid: "Identiti Sah",
                aid_eligible: "LAYAK BANTUAN (STR)",
                aid_desc: "Pemegang kad ini layak menerima bantuan tunai kerajaan bagi kategori B40.",
                lbl_kin: "Waris",
                location: "Lokasi:",
                opt_senior: "Warga Emas",
                opt_pwd_phys: "OKU (Fizikal)",
                opt_pwd_hear: "OKU (Pendengaran)",
                opt_child: "Kanak-kanak",
                opt_normal: "Normal",
                nav_card: "Kad",
                nav_profile: "Profil",
                nav_home: "Utama",
                nav_scan: "Imbas",
                alert_reset: "Reset data?",
                alert_reset_success: "Data direset.",
                alert_profile_updated: "Profil dikemaskini.",
                alert_ram_gen: "Kunci RAM-Disk Berjaya Dijana.",
                alert_cam_fail: "Kamera gagal. Guna Nombor PIN?",
                alert_invalid_qr: "Format QR tidak sah atau bukan pengguna Smart IC.",
                alert_cam_init_fail: "Gagal memulakan kamera. Sila pastikan kebenaran diberikan.",
                session_timeout: "SESI TAMAT",
                ram_cleared: "RAM Dibersihkan.",
                aid_status_title: "Status Kebajikan",
                aid_status_eligible: "LAYAK BANTUAN KERAJAAN",
                aid_status_eligible_sub: "Sumbangan Tunai Rahmah (STR) Aktif",
                aid_status_none: "TIADA BANTUAN AKTIF",
                aid_status_cat: "Kategori"
            },
            en: {
                app_title: "MyID Touch",
                app_subtitle: "Volatile Memory Session",
                badge_ram: "VOLATILE RAM-DISK",
                badge_dms: "DEAD MAN'S SWITCH",
                status_locked: "LOCKED",
                btn_fingerprint: "UNLOCK (FINGERPRINT)",
                btn_pin: "Use PIN Number",
                lbl_officer: "Officer",
                btn_officer: "Officer Login",
                footer_version: "Secure RAM-Disk v2.1. Data wipes on power loss.",
                btn_cancel: "Cancel",
                loading_ram: "LOADING TO RAM...",
                generating_keys: "Generating Volatile Keys...",
                ram_decrypted_title: "RAM-Disk Decrypted",
                ram_decrypted_desc: "Data is live in volatile memory.",
                ram_encrypted_title: "DATA ENCRYPTED",
                ram_encrypted_desc: "Log in to decrypt from storage.",
                nfc_active: "NFC Active",
                lbl_blood: "Blood Type",
                lbl_allergy: "Main Allergy",
                profile_title: "My Profile",
                btn_reset: "Reset Data",
                lbl_pin_set: "Security PIN (6 Digits)",
                desc_pin: "Used if biometrics fail.",
                lbl_name: "Full Name",
                lbl_ic: "IC No.",
                lbl_category: "Category",
                lbl_income: "Income",
                lbl_ice: "Emergency Contact (ICE)",
                ph_ice_name: "Next of Kin Name",
                ph_ice_phone: "Phone No.",
                btn_save: "Save",
                dash_scans: "Today's Scans",
                dash_aid: "Aid Recipients",
                dash_activity: "Recent Activity",
                dash_no_rec: "No scan records.",
                btn_start_scan: "Start Scanning",
                btn_back_dash: "Back to Dashboard",
                pin_title: "Enter PIN",
                pin_desc: "Your 6-digit security number.",
                btn_enter: "Enter",
                gov_access_title: "Officer Access",
                btn_verify: "Verify",
                res_valid: "Valid Identity",
                aid_eligible: "ELIGIBLE FOR AID (STR)",
                aid_desc: "Cardholder is eligible for government cash aid (B40 category).",
                lbl_kin: "Next of Kin",
                location: "Location:",
                opt_senior: "Senior Citizen",
                opt_pwd_phys: "PWD (Physical)",
                opt_pwd_hear: "PWD (Hearing)",
                opt_child: "Child",
                opt_normal: "Normal",
                nav_card: "Card",
                nav_profile: "Profile",
                nav_home: "Home",
                nav_scan: "Scan",
                alert_reset: "Reset data?",
                alert_reset_success: "Data reset.",
                alert_profile_updated: "Profile updated.",
                alert_ram_gen: "RAM-Disk Key Generated Successfully.",
                alert_cam_fail: "Camera failed. Use PIN?",
                alert_invalid_qr: "Invalid QR format or not a Smart IC user.",
                alert_cam_init_fail: "Failed to start camera. Please ensure permissions are granted.",
                session_timeout: "SESSION TIMEOUT",
                ram_cleared: "RAM Cleared.",
                aid_status_title: "Welfare Status",
                aid_status_eligible: "ELIGIBLE FOR GOV AID",
                aid_status_eligible_sub: "Cash Contribution (STR) Active",
                aid_status_none: "NO ACTIVE AID",
                aid_status_cat: "Category"
            }
        };

        let currentLang = 'ms';

        // --- DATA & STATE ---
        const DEFAULT_DATA = {
            name: "Ali Bin Abu", ic: "850101-14-1234", category: "OKU (Pendengaran)",
            incomeGroup: "B40", 
            pin: "123456", // Default PIN
            blood: "O+", allergies: "Kacang Tanah", iceName: "Rey", icePhone: "0109507043"
        };
        let userData = { ...DEFAULT_DATA };
        let currentUserRole = null;
        let html5QrCode = null; let isScanning = false;
        let recentScans = [];
        let aidCounter = 0; 
        let scanCounter = 0;

        // --- FEATURE 1: VOLATILE RAM-DISK KEY ---
        let volatileSessionKey = null;

        // --- FEATURE 2: DEAD MAN'S SWITCH (AUTO-LOCK) ---
        let inactivityTimer;
        const TIMEOUT_DURATION = 20
        let timeLeft = TIMEOUT_DURATION;
        let dmsInterval;

        // --- INIT ---
        window.onload = () => { loadFromStorage(); initDMSListeners(); updateLanguage(currentLang); };

        // --- TRANSLATION LOGIC ---
        function toggleLanguage() {
            currentLang = currentLang === 'ms' ? 'en' : 'ms';
            
            // Update Toggle Button Text
            const btn = document.getElementById('header-lang-btn');
            if(btn) btn.innerText = currentLang === 'ms' ? 'BM' : 'EN';

            const loginBtn = document.getElementById('login-lang-btn');
            if(loginBtn) {
                 loginBtn.innerHTML = currentLang === 'ms' ? '<i class="fa-solid fa-globe mr-1"></i> English' : '<i class="fa-solid fa-globe mr-1"></i> Bahasa';
            }

            updateLanguage(currentLang);
            // Refresh UI components that use dynamic strings
            if(currentUserRole === 'public') loadDataToUI();
            if(currentUserRole === 'gov') setupUI(); // Refreshes nav
        }

        function updateLanguage(lang) {
            const t = translations[lang];
            
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(t[key]) {
                    if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        if(el.getAttribute('placeholder')) el.placeholder = t[key];
                    } else {
                        el.innerText = t[key];
                    }
                }
            });
        }

        function getTrans(key) {
            return translations[currentLang][key] || key;
        }

        // --- STORAGE ---
        function loadFromStorage() {
            const saved = localStorage.getItem('smart_ic_data');
            if(saved) userData = JSON.parse(saved);
        }
        function saveToStorage() { localStorage.setItem('smart_ic_data', JSON.stringify(userData)); }
        function resetData() { 
            if(confirm(getTrans('alert_reset'))) { 
                localStorage.removeItem('smart_ic_data'); 
                userData = { ...DEFAULT_DATA }; 
                loadDataToUI(); 
                generateQR(); 
                alert(getTrans('alert_reset_success')); 
            }
        }

        // --- DEAD MAN'S SWITCH LOGIC ---
        function initDMSListeners() {
            document.addEventListener("mousemove", resetDMSTimer);
            document.addEventListener("keypress", resetDMSTimer);
            document.addEventListener("touchstart", resetDMSTimer);
            document.addEventListener("click", resetDMSTimer);
        }

        function startDMSTimer() {
            document.getElementById('dms-container').classList.remove('hidden');
            const bar = document.getElementById('dms-bar');
            
            timeLeft = TIMEOUT_DURATION;
            clearInterval(dmsInterval);
            
            dmsInterval = setInterval(() => {
                timeLeft--;
                const pct = (timeLeft / TIMEOUT_DURATION) * 100;
                bar.style.width = pct + "%";
                
                if (timeLeft < 15) {
                    bar.classList.remove('bg-emerald-500', 'bg-yellow-500');
                    bar.classList.add('dms-warning');
                } else if (timeLeft < 30) {
                    bar.classList.remove('bg-emerald-500');
                    bar.classList.add('bg-yellow-500');
                } else {
                    bar.classList.remove('bg-yellow-500', 'dms-warning');
                    bar.classList.add('bg-emerald-500');
                }

                if (timeLeft <= 0) {
                    triggerDeadMansSwitch();
                }
            }, 1000);
        }

        function resetDMSTimer() {
            if(currentUserRole) {
                timeLeft = TIMEOUT_DURATION;
                const bar = document.getElementById('dms-bar');
                bar.style.width = "100%";
                bar.classList.remove('dms-warning', 'bg-yellow-500');
                bar.classList.add('bg-emerald-500');
            }
        }

        function stopDMSTimer() {
            clearInterval(dmsInterval);
            document.getElementById('dms-container').classList.add('hidden');
        }

        function triggerDeadMansSwitch() {
            stopDMSTimer();
            volatileSessionKey = null;
            currentUserRole = null;
            document.getElementById('main-bg').innerHTML += `<div class="fixed inset-0 bg-red-900/90 z-[60] flex items-center justify-center flex-col text-white animate-pulse"><i class="fa-solid fa-triangle-exclamation text-6xl mb-4"></i><h1 class="text-2xl font-bold">${getTrans('session_timeout')}</h1><p>${getTrans('ram_cleared')}</p></div>`;
            setTimeout(() => location.reload(), 2000);
        }

        // --- UI & LOGIC ---
        function toggleContrast() { document.body.classList.toggle('high-contrast'); }
        
        // --- LOGIN LOGIC ---
        function loginAs(role, method) {
            currentUserRole = role;
            if (method === 'bio') {
                volatileSessionKey = "RAM-KEY-" + Math.random().toString(36).substr(2, 9);
            } else {
                volatileSessionKey = "PIN-KEY-FALLBACK";
            }
            startDMSTimer();
            closePinLogin();
            closeGovLogin();
            closeBioScanner();
            setupUI();
        }

        // --- GOV AUTH ---
        function showGovLogin() { document.getElementById('modal-gov-login').classList.remove('hidden'); document.getElementById('gov-pass').focus(); }
        function closeGovLogin() { document.getElementById('modal-gov-login').classList.add('hidden'); }
        function verifyGov() {
            if(document.getElementById('gov-pass').value === '1234') { loginAs('gov', 'pin'); }
            else { alert("Kod Salah"); }
        }

        // --- PIN AUTH ---
        function showPinLogin() { document.getElementById('modal-pin-login').classList.remove('hidden'); document.getElementById('user-pin-input').value = ''; document.getElementById('user-pin-input').focus(); }
        function closePinLogin() { document.getElementById('modal-pin-login').classList.add('hidden'); }
        function verifyUserPin() {
            const input = document.getElementById('user-pin-input').value;
            if(input === userData.pin) {
                loginAs('public', 'pin');
            } else {
                shakeModal('modal-pin-login');
                document.getElementById('user-pin-input').value = '';
            }
        }
        function togglePinVisibility() {
            const input = document.getElementById('input-pin');
            input.type = input.type === "password" ? "text" : "password";
        }

        function shakeModal(id) {
            const m = document.getElementById(id).firstElementChild;
            m.classList.add('animate-shake'); setTimeout(()=>m.classList.remove('animate-shake'),300);
        }
        function logout() { 
            volatileSessionKey = null; 
            stopDMSTimer();
            location.reload(); 
        }

        function setupUI() {
            document.getElementById('view-auth').classList.add('hidden');
            document.getElementById('app-header').classList.remove('hidden');
            const nav = document.getElementById('nav-items-container');
            const mainBg = document.getElementById('main-bg');

            if(currentUserRole === 'public') {
                document.getElementById('header-title').innerText = getTrans('app_title');
                document.getElementById('header-role-badge').innerText = "AWAM";
                if(volatileSessionKey) document.getElementById('ram-status-icon').classList.remove('hidden');

                nav.innerHTML = `
                    <button onclick="switchTab('card')" id="nav-card" class="nav-btn flex-1 py-3 text-blue-600 border-t-2 border-blue-600"><i class="fa-solid fa-address-card block text-xl mb-1"></i><span class="text-[10px]">${getTrans('nav_card')}</span></button>
                    <button onclick="switchTab('profile')" id="nav-profile" class="nav-btn flex-1 py-3 text-gray-400"><i class="fa-solid fa-user-pen block text-xl mb-1"></i><span class="text-[10px]">${getTrans('nav_profile')}</span></button>
                `;
                loadDataToUI(); generateQR(); switchTab('card');
            } else {
                document.getElementById('header-title').innerText = "Enforcement";
                document.getElementById('header-role-badge').innerText = "PEGAWAI";
                document.getElementById('header-role-badge').className = "text-[10px] bg-green-600 px-2 py-1 rounded";
                mainBg.className = "flex-1 overflow-y-auto relative pb-20 w-full h-full bg-white";
                nav.innerHTML = `
                    <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn flex-1 py-3 text-green-600 border-t-2 border-green-600"><i class="fa-solid fa-chart-pie block text-xl mb-1"></i><span class="text-[10px]">${getTrans('nav_home')}</span></button>
                    <button onclick="switchTab('scanner')" id="nav-scanner" class="nav-btn flex-1 py-3 text-gray-400"><i class="fa-solid fa-qrcode block text-xl mb-1"></i><span class="text-[10px]">${getTrans('nav_scan')}</span></button>
                `;
                switchTab('dashboard');
            }
            document.getElementById('bottom-nav').classList.remove('hidden');
        }

        function switchTab(tabId) {
            if(tabId!=='scanner' && isScanning) stopCamera();
            ['view-card','view-profile','view-scanner','view-dashboard'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            document.getElementById('view-'+tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(btn=>btn.className="nav-btn flex-1 py-3 text-gray-400");
            const activeColor = currentUserRole==='public'?'text-blue-600 border-blue-600':'text-green-600 border-green-600';
            const btn=document.getElementById('nav-'+tabId);
            if(btn) btn.className=`nav-btn flex-1 py-3 border-t-2 ${activeColor}`;
        }

        // --- PUBLIC FUNCTIONS ---
        function loadDataToUI() {
            document.getElementById('card-name').innerText = userData.name;
            
            if (volatileSessionKey) {
                document.getElementById('card-ic').innerText = userData.ic;
                document.getElementById('status-blood').innerText = userData.blood;
                document.getElementById('status-allergy').innerText = userData.allergies;
                document.getElementById('ram-active-banner').classList.remove('hidden');
                document.getElementById('ram-missing-banner').classList.add('hidden');
                document.querySelectorAll('.sensitive-mask').forEach(el => el.classList.add('hidden'));
            } else {
                document.getElementById('card-ic').innerText = "******-**-****";
                document.getElementById('status-blood').innerText = "**";
                document.getElementById('status-allergy').innerText = "ENCRYPTED";
                document.getElementById('ram-active-banner').classList.add('hidden');
                document.getElementById('ram-missing-banner').classList.remove('hidden');
                document.querySelectorAll('.sensitive-mask').forEach(el => el.classList.remove('hidden'));
            }

            document.getElementById('card-category').innerText = userData.category;
            document.getElementById('card-income').innerText = userData.incomeGroup;

            // Handle Aid Status Card - DYNAMIC TEXT
            const aidCard = document.getElementById('aid-status-card');
            
            if(userData.incomeGroup === 'B40') {
                aidCard.classList.remove('hidden');
                aidCard.classList.add('bg-green-50', 'border-green-500');
                aidCard.innerHTML = `<p class="text-[10px] font-bold text-green-600 uppercase mb-1">${getTrans('aid_status_title')}</p><div class="flex items-center gap-3"><div class="bg-green-200 p-2 rounded-full text-green-800"><i class="fa-solid fa-hand-holding-dollar"></i></div><div><p class="font-bold text-green-900 text-sm">${getTrans('aid_status_eligible')}</p><p class="text-[10px] text-green-700">${getTrans('aid_status_eligible_sub')}</p></div></div>`;
            } else {
                aidCard.classList.remove('hidden');
                aidCard.classList.add('bg-gray-50', 'border-gray-300');
                aidCard.classList.remove('bg-green-50', 'border-green-500');
                aidCard.innerHTML = `<p class="text-[10px] font-bold text-gray-500 uppercase mb-1">${getTrans('aid_status_title')}</p><div class="flex items-center gap-3 opacity-60"><div class="bg-gray-200 p-2 rounded-full text-gray-600"><i class="fa-solid fa-ban"></i></div><div><p class="font-bold text-gray-700 text-sm">${getTrans('aid_status_none')}</p><p class="text-[10px] text-gray-500">${getTrans('aid_status_cat')} ${userData.incomeGroup}</p></div></div>`;
            }

            // Fill Form
            document.getElementById('input-name').value = userData.name;
            document.getElementById('input-ic').value = userData.ic;
            document.getElementById('input-category').value = userData.category;
            document.getElementById('input-income').value = userData.incomeGroup;
            document.getElementById('input-pin').value = userData.pin; 
            document.getElementById('input-blood').value = userData.blood;
            document.getElementById('input-allergies').value = userData.allergies;
            document.getElementById('input-ice-name').value = userData.iceName;
            document.getElementById('input-ice-phone').value = userData.icePhone;
        }

        function saveData() {
            userData.name = document.getElementById('input-name').value;
            userData.ic = document.getElementById('input-ic').value;
            userData.category = document.getElementById('input-category').value;
            userData.incomeGroup = document.getElementById('input-income').value;
            userData.pin = document.getElementById('input-pin').value;
            userData.blood = document.getElementById('input-blood').value;
            userData.allergies = document.getElementById('input-allergies').value;
            userData.iceName = document.getElementById('input-ice-name').value;
            userData.icePhone = document.getElementById('input-ice-phone').value;
            
            saveToStorage(); loadDataToUI(); generateQR();
            alert(getTrans('alert_profile_updated')); switchTab('card');
        }

        function generateQR() {
            document.getElementById("main-qr-display").innerHTML = "";
            document.getElementById("card-qr-small").innerHTML = "";
            const qrData = JSON.stringify(userData);
            try {
                new QRCode(document.getElementById("main-qr-display"), { text: qrData, width: 140, height: 140, correctLevel: QRCode.CorrectLevel.L });
                new QRCode(document.getElementById("card-qr-small"), { text: qrData, width: 45, height: 45, correctLevel: QRCode.CorrectLevel.L });
            } catch(e) {}
        }
        
        function triggerSOS() { window.open(`https://wa.me/${userData.icePhone}?text=SOS`); }

        // --- GOV SCANNER & BIOMETRIC MOCK ---
        async function startBiometricAuth() {
             document.getElementById('view-bio-scan').classList.remove('hidden');
             const video = document.getElementById('bio-video');
             try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                setTimeout(() => {
                    stream.getTracks().forEach(t=>t.stop());
                    document.getElementById('view-bio-scan').classList.add('hidden');
                    alert(getTrans('alert_ram_gen'));
                    loginAs('public', 'bio');
                }, 2500);
             } catch(e) { 
                 if(confirm(getTrans('alert_cam_fail'))) {
                    closeBioScanner();
                    showPinLogin();
                 } else {
                    closeBioScanner();
                 }
            }
        }
        function closeBioScanner() { document.getElementById('view-bio-scan').classList.add('hidden'); }

        // --- UPDATED SCANNER LOGIC (From Code 2) ---
        function updateRecentScans() {
            const list = document.getElementById('recent-scans-list');
            list.innerHTML = '';
            if(recentScans.length === 0) {
                list.innerHTML = `<li class="p-4 text-sm text-center text-gray-400 italic">${getTrans('dash_no_rec')}</li>`;
                return;
            }
            recentScans.forEach(scan => {
                const li = document.createElement('li');
                li.className = "p-3 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition";
                li.innerHTML = `
                    <div>
                        <p class="font-bold text-sm text-gray-800">${scan.name}</p>
                        <p class="text-[10px] text-gray-500">${scan.time}</p>
                    </div>
                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">${scan.cat}</span>
                `;
                list.appendChild(li);
            });
            // Update counts
            document.getElementById('stat-scans').innerText = scanCounter;
            document.getElementById('stat-aid').innerText = aidCounter;
        }

        function startScan() {
            document.getElementById('scan-placeholder').classList.add('hidden');
            const btns = document.getElementById('scan-controls').querySelectorAll('button');
            btns[0].classList.add('hidden'); // Start btn
            btns[1].classList.remove('hidden'); // Stop btn

            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                (decodedText) => {
                    stopCamera();
                    try { 
                        const data = JSON.parse(decodedText);
                        
                        // Add to recent scans
                        const now = new Date();
                        recentScans.unshift({
                            name: data.name,
                            cat: data.category.split(' ')[0], // Short category
                            time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                        });
                        scanCounter++;
                        if(data.incomeGroup === 'B40') aidCounter++;
                        
                        updateRecentScans();
                        showResult(data); 
                    } 
                    catch(e) { alert(getTrans('alert_invalid_qr')); }
                },
                (err) => {}
            ).catch(err => {
                 console.log("Error starting camera", err);
                 alert(getTrans('alert_cam_init_fail'));
                 resetScannerUI();
            });
            isScanning = true;
        }

        function stopCamera() {
            if(html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    isScanning = false;
                    resetScannerUI();
                }).catch(err => {
                    console.error("Failed to stop camera", err);
                    resetScannerUI();
                });
            }
        }

        function resetScannerUI() {
            document.getElementById('scan-placeholder').classList.remove('hidden');
            const btns = document.getElementById('scan-controls').querySelectorAll('button');
            btns[0].classList.remove('hidden'); // Start btn
            btns[1].classList.add('hidden'); // Stop btn
        }

        // --- UPDATED SHOW RESULT (MATCHING PRO SYSTEM IDS) ---
        function showResult(data) {
            document.getElementById('res-name').innerText = data.name;
            document.getElementById('res-ic').innerText = data.ic;
            document.getElementById('res-category').innerText = data.category; // Updated ID

            document.getElementById('res-blood').innerText = data.blood;
            document.getElementById('res-allergies').innerText = data.allergies;
            document.getElementById('res-ice-name').innerText = data.iceName;
            document.getElementById('btn-call').href = `tel:${data.icePhone}`;
            
            // Mock GPS
            if(navigator.geolocation) {
                 navigator.geolocation.getCurrentPosition(p => {
                    document.getElementById('res-geo').innerText = `${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`;
                 });
            } else {
                 document.getElementById('res-geo').innerText = "W.P. Kuala Lumpur"; 
            }

            document.getElementById('modal-result').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal-result').classList.add('hidden'); }
    </script>
</body>
</html>